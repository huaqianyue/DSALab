<nz-button-group>
  <!-- Âà∑Êñ∞ÊåâÈíÆ -->
  <button 
    nz-button 
    nzType="default" 
    nzSize="small"
    [nzLoading]="isRefreshing"
    (click)="refreshProblems()" 
    nz-tooltip 
    nzTooltipTitle="Âà∑Êñ∞È¢òÁõÆÂàóË°®"
    class="compact-button">
    <i nz-icon nzType="reload"></i> Âà∑Êñ∞
  </button>

  <!-- ÂØºÂÖ•ÊåâÈíÆ -->
  <button 
    nz-button 
    nzType="default" 
    nzSize="small"
    (click)="importProblems()" 
    nz-tooltip 
    nzTooltipTitle="ÂØºÂÖ•È¢òÁõÆÂàóË°®"
    class="compact-button">
    <i nz-icon nzType="import"></i> ÂØºÂÖ•
  </button>

  <!-- ‰øùÂ≠òÊåâÈíÆ -->
  <button 
    nz-button 
    nzType="default" 
    nzSize="small"
    [nzLoading]="isSaving"
    [disabled]="!currentProblem"
    (click)="saveCurrentProblem()" 
    nz-tooltip 
    nzTooltipTitle="‰øùÂ≠ò"
    class="compact-button">
    <i nz-icon nzType="save"></i> ‰øùÂ≠ò
  </button>

  <!-- ÂØºÂá∫ÊåâÈíÆ -->
  <button 
    nz-button 
    nzType="default" 
    nzSize="small"
    (click)="openExportModal()" 
    nz-tooltip 
    nzTooltipTitle="ÂØºÂá∫ÈÄâ‰∏≠È¢òÁõÆ"
    class="compact-button">
    <i nz-icon nzType="export"></i> ÂØºÂá∫
  </button>
</nz-button-group>

<!-- ÂØºÂá∫Ê®°ÊÄÅÊ°Ü -->
<nz-modal
  [(nzVisible)]="exportModalVisible"
  nzTitle="ÂØºÂá∫È¢òÁõÆ"
  nzWidth="600px"
  [nzOkLoading]="isExporting"
  nzOkText="ÂØºÂá∫"
  nzCancelText="ÂèñÊ∂à"
  (nzOnOk)="confirmExport()"
  (nzOnCancel)="closeExportModal()">
  
  <ng-container *nzModalContent>
    <div class="export-modal-content">
      <!-- Áî®Êà∑‰ø°ÊÅØËæìÂÖ• -->
      <div class="user-info-input">
        <nz-form-item>
          <nz-form-label [nzSpan]="4" nzRequired>ÂßìÂêç</nz-form-label>
          <nz-form-control [nzSpan]="20">
            <input 
              nz-input 
              [(ngModel)]="exportUserName" 
              placeholder="ËØ∑ËæìÂÖ•ÊÇ®ÁöÑÂßìÂêç"
              maxlength="50" />
          </nz-form-control>
        </nz-form-item>
        <nz-form-item>
          <nz-form-label [nzSpan]="4" nzRequired>Â≠¶Âè∑</nz-form-label>
          <nz-form-control [nzSpan]="20">
            <input 
              nz-input 
              [(ngModel)]="exportStudentId" 
              placeholder="ËØ∑ËæìÂÖ•ÊÇ®ÁöÑÂ≠¶Âè∑"
              maxlength="20" />
          </nz-form-control>
        </nz-form-item>
      </div>

      <!-- ÈÄâÊã©È¢òÁõÆ -->
      <div class="problem-selection">
        <div class="selection-header">
          <h4>ÈÄâÊã©Ë¶ÅÂØºÂá∫ÁöÑÈ¢òÁõÆÔºàÊú¨Âú∞‰øùÂ≠òÔºâÔºö</h4>
          <div class="selection-actions">
            <label class="select-all-checkbox">
              <input 
                type="checkbox" 
                [checked]="isAllSelected()" 
                [indeterminate]="isIndeterminate()"
                (change)="toggleSelectAll()">
              ÂÖ®ÈÄâ ({{ getExportableProblemsCount() }} ‰∏™ÂèØÂØºÂá∫)
            </label>
          </div>
        </div>

        <div class="problem-list">
          <nz-list nzSize="small" [nzDataSource]="problems" [nzRenderItem]="problemItem">
            <ng-template #problemItem let-problem>
              <nz-list-item 
                class="problem-item"
                [class.disabled]="problem.isDelete || !hasProblemContent(problem)"
                [attr.data-problem-id]="problem.id"
                *ngIf="!problem.isDelete">
                
                <nz-list-item-meta>
                  <nz-list-item-meta-title>
                    <label class="problem-checkbox" [class.disabled]="!hasProblemContent(problem)">
                      <input 
                        type="checkbox" 
                        [checked]="isProblemSelected(problem.id)"
                        [disabled]="!hasProblemContent(problem)"
                        (change)="toggleProblemSelection(problem.id)"
                        (click)="$event.stopPropagation()">
                      <span class="problem-title">
                        {{ problem.shortDescription }}
                        <span class="current-problem-indicator" *ngIf="currentProblem && currentProblem.id === problem.id">
                          üîµ ÂΩìÂâçÈ¢òÁõÆ
                        </span>
                      </span>
                    </label>
                  </nz-list-item-meta-title>
                  
                  <nz-list-item-meta-description>
                    <div class="problem-status">
                      <nz-tag nzColor="blue" *ngIf="problem.Code !== ''">
                        <i nz-icon nzType="code"></i> ‰ª£Á†Å
                      </nz-tag>
                      <nz-tag nzColor="green" *ngIf="problem.Audio !== ''">
                        <i nz-icon nzType="sound"></i> Èü≥È¢ë
                      </nz-tag>
                      <nz-tag [nzColor]="getTestScoreTagColor(problem)" *ngIf="hasTestScore(problem)">
                        <i nz-icon nzType="experiment"></i> {{ getTestScoreText(problem) }}
                      </nz-tag>
                      <nz-tag [nzColor]="getTestStatusTagColor(problem)" *ngIf="hasTestStatus(problem)">
                        {{ getTestStatusText(problem) }}
                      </nz-tag>
                      <nz-tag nzColor="orange" *ngIf="!hasProblemContent(problem) && (problem.Code !== '' || problem.Audio !== '')">
                        <i nz-icon nzType="warning"></i> Áº∫Â∞ë{{ problem.Code === '' ? '‰ª£Á†Å' : 'Èü≥È¢ë' }}
                      </nz-tag>
                      <nz-tag nzColor="default" *ngIf="problem.Code === '' && problem.Audio === ''">
                        <i nz-icon nzType="exclamation-circle"></i> Êó†ÂÜÖÂÆπ
                      </nz-tag>
                    </div>
                  </nz-list-item-meta-description>
                </nz-list-item-meta>
              </nz-list-item>
            </ng-template>
          </nz-list>
        </div>

        <!-- ÈÄâÊã©ÁªüËÆ° -->
        <div class="selection-summary" *ngIf="selectedProblemIds.length > 0">
          <nz-alert 
            nzType="success" 
            [nzMessage]="'Â∑≤ÈÄâÊã© ' + selectedProblemIds.length + ' ‰∏™È¢òÁõÆËøõË°åÂØºÂá∫'"
            nzShowIcon>
          </nz-alert>
        </div>
      </div>

      <!-- Á©∫Áä∂ÊÄÅ -->
      <div class="empty-state" *ngIf="problems.length === 0">
        <nz-empty nzNotFoundContent="ÊöÇÊó†Êú¨Âú∞‰øùÂ≠òÁöÑÈ¢òÁõÆÂèØÂØºÂá∫"></nz-empty>
      </div>
    </div>
  </ng-container>
</nz-modal>